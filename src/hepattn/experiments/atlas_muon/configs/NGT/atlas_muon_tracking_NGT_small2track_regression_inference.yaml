seed_everything: 42
name: TRK-ATLAS-Muon-smallModel
ckpt_path: /eos/project/e/end-to-end-muon-tracking/tracking/data/best2tracktracking/TRK-ATLAS-Muon-smallModel_20250915-T192111/ckpts/epoch=008-val_loss=1.62751.ckpt

data:

  train_dir: /scratch/ml_test_data_156000_hdf5_filtered_wp0990_maxtrk2_maxhit500
  val_dir: /scratch/ml_test_data_156000_hdf5_filtered_wp0990_maxtrk2_maxhit500
  # train_dir: /scratch/ml_training_data_2694000_hdf5_filtered_wp0990_maxtrk2_maxhit500
  # val_dir: /scratch/ml_validation_data_144000_hdf5_filtered_wp0990_maxtrk2_maxhit500
  test_dir: /scratch/ml_test_data_156000_hdf5_filtered_wp0990_maxtrk2_maxhit500

  # hit_eval_train: /scratch/epoch=021-val_auc=0.99969_ml_training_data_2694000_hdf5_eval.h5
  # hit_eval_val: /scratch/epoch=021-val_auc=0.99969_ml_validation_data_144000_hdf5_eval.h5
  # hit_eval_test: /home/iwsatlas1/jrenusch/master_thesis/tracking/data/HC-v3_20250622-T103156/ckpts/epoch=046-val_acc=0.96694_test_data_eval.h5
  
  num_workers: 10
  num_train: -1
  num_test: -1
  num_val: -1
  batch_size: 1
  # batch_size: 32
  # use_smart_batching: false  # Disable smart batching as requested

  # ATLAS muon data parameters
  event_max_num_particles: &num_objects 2  # Typically fewer particles per event in muon data

  inputs:
    hit:
      # Global hit coordinates
      - spacePoint_globEdgeHighX
      - spacePoint_globEdgeHighY
      - spacePoint_globEdgeHighZ
      - spacePoint_globEdgeLowX
      - spacePoint_globEdgeLowY
      - spacePoint_globEdgeLowZ
      - spacePoint_time
      - spacePoint_driftR
      # Add covariance information
      - spacePoint_covXX
      - spacePoint_covXY
      - spacePoint_covYX
      - spacePoint_covYY
      # Add detector information
      - spacePoint_channel
      - spacePoint_layer
      - spacePoint_stationPhi
      - spacePoint_stationEta
      - spacePoint_stationIndex
      - spacePoint_technology
      # Add derived hit fields
      - r  # Radial distance
      - s  # 3D distance
      - theta  # Polar angle
      - phi  # Azimuthal angle

  targets:
    # hit:
    #   - on_valid_particle
    particle:
      - truthMuon_pt
      - truthMuon_q
      - truthMuon_eta
      - truthMuon_phi
      - truthMuon_qpt

trainer:
  # Training stuff here
  # max_epochs: 50
  max_epochs: 25
  num_sanity_val_steps: 1
  accelerator: gpu
  # devices: [0,1,2]
  devices: [0]
  # devices: -1
  precision: bf16-mixed
  log_every_n_steps: 50 
  default_root_dir: logs
  gradient_clip_val: 0.1
  enable_progress_bar: true
  #strategy:
   # class_path: lightning.pytorch.strategies.DDPStrategy
    #init_args:
     # find_unused_parameters: true

  #profiler:
  #  class_path: lightning.pytorch.profilers.PyTorchProfiler
  #  init_args:
  #    dirpath: ./profile_logs/
  #    filename: profile.json

  # Specify loggers here
  logger:
    class_path: lightning.pytorch.loggers.CometLogger
    init_args:
      project_name: atlas_muon_tracking

  callbacks:
    # - class_path: hepattn.callbacks.Compile
    - class_path: hepattn.callbacks.InferenceTimer
    - class_path: hepattn.callbacks.SaveConfig
    - class_path: hepattn.callbacks.Checkpoint
      init_args:
        monitor: val/loss
        mode: min
        save_top_k: 5
    - class_path: hepattn.callbacks.PredictionWriter
      init_args:
        write_inputs: false
        write_outputs: true
        write_preds: true
        write_targets: false
        write_losses: false
    - class_path: lightning.pytorch.callbacks.ModelSummary
    - class_path: lightning.pytorch.callbacks.LearningRateMonitor
    - class_path: lightning.pytorch.callbacks.TQDMProgressBar
      init_args:
        refresh_rate: 50
    - class_path: lightning.pytorch.callbacks.EarlyStopping
      init_args:
        monitor: val/loss
        patience: 15 
        min_delta: 0.0
        mode: min
        verbose: True

model:
  optimizer: Lion

  # Learning rate scheduler config
  # lrs_config:
  #   initial: 1e-5
  #   max: 2e-5
  #   end: 1e-5
  #   pct_start: 0.01
  #   skip_scheduler: false
  #   weight_decay: 1e-5
  lrs_config:
    initial: 1e-6
    max: 1e-5
    end: 1e-7
    pct_start: 0.5
    weight_decay: 10e-2
    skip_scheduler: false
  # lrs_config:
  #   initial: 1e-6
  #   max: 1e-5
  #   end: 1e-6
  #   pct_start: 0.2
  #   weight_decay: 5e-4
  #   skip_scheduler: false

  # Whether to use multi task learning or not
  mtl: false

  model:
    class_path: hepattn.models.MaskFormer
    init_args:
      dim: &dim 128
      num_queries: *num_objects
      input_sort_field: phi
      # record_intermediate_embeddings: false
      use_attn_masks: true
      use_query_masks: false
      input_nets:
        class_path: torch.nn.ModuleList
        init_args:
          modules:
            - class_path: hepattn.models.InputNet
              init_args:
                input_name: hit
                fields:
                  # Global hit coordinates
                  - spacePoint_globEdgeHighX
                  - spacePoint_globEdgeHighY
                  - spacePoint_globEdgeHighZ
                  - spacePoint_globEdgeLowX
                  - spacePoint_globEdgeLowY
                  - spacePoint_globEdgeLowZ
                  - spacePoint_time
                  - spacePoint_driftR
                  # Add covariance information
                  - spacePoint_covXX
                  - spacePoint_covXY
                  - spacePoint_covYX
                  - spacePoint_covYY
                  # Add detector information
                  - spacePoint_channel
                  - spacePoint_layer
                  - spacePoint_stationPhi
                  - spacePoint_stationEta
                  - spacePoint_technology
                  - spacePoint_stationIndex
                  # # Add derived hit fields
                  - r  # Radial distance
                  - s  # 3D distance
                  - theta  # Polar angle
                  - phi  # Azimuthal angle
                net:
                  class_path: hepattn.models.Dense
                  init_args:
                    input_size: 22
                    output_size: *dim
                posenc:
                  class_path: hepattn.models.posenc.FourierPositionEncoder
                  init_args:
                    input_name: hit
                    dim: *dim
                    fields:
                      - r
                      # - eta
                      - phi
                    dim: *dim
                    scale: 0.1

      # encoder:
      #   class_path: hepattn.models.Encoder
      #   init_args:
      #     num_layers: 8
      #     dim: *dim
      #     attn_type: flash-varlen
      #     # window_size: 64
      #     # window_wrap: true
      #     # hybrid_norm: true
      #     norm: RMSNorm
      encoder:
        class_path: hepattn.models.Encoder
        init_args:
          num_layers: 3
          dim: *dim
          # attn_type: flash
          attn_type: flash-varlen
          hybrid_norm: true

          value_residual: true
          # num_register_tokens: 8
          attn_kwargs:
            num_heads: 8

      # decoder:
      #   num_decoder_layers: 4
      #   num_queries: *num_particles
      #   mask_attention: true
      #   use_query_masks: false
      #   decoder_layer_config:
      #     dim: *dim
      #     hybrid_norm: true
      #     attn_kwargs:
      #       num_heads: 16

      matcher:
        class_path: hepattn.models.matcher.Matcher
        init_args:
          default_solver: scipy
          adaptive_solver: false
          adaptive_check_interval: 1000
          parallel_solver: true
          n_jobs: 16

      num_decoder_layers: 3
      # intermediate_losses: true
      decoder_layer_config:
        dim: *dim
        norm: RMSNorm
        # hybrid_norm: true
        mask_attention: true
      # matcher:
      #   class_path: hepattn.models.matcher.Matcher
      #   init_args:
      #     default_solver: scipy
      #     adaptive_solver: false
      #     adaptive_check_interval: 1000
      tasks:
        class_path: torch.nn.ModuleList
        init_args:
          modules:
            - class_path: hepattn.models.task.ObjectValidTask
              init_args:
                name: track_valid
                input_object: query
                output_object: track
                target_object: particle
                losses:
                  object_bce: 1.0
                costs:
                  object_bce: 10.0
                dim: *dim
                null_weight: 1.0
                mask_queries: false
            - class_path: hepattn.models.task.ObjectHitMaskTask
              init_args:
                name: track_hit_valid
                input_hit: hit
                input_object: query
                output_object: track
                target_object: particle
                # pred_threshold: 0.1
                # logit_scale: 4.0
                # losses:
                #   mask_bce: 10.0
                # costs:
                #   mask_bce: 10.0
                # dim: *dim
                # null_weight: 1.0
                losses:
                  mask_bce: 1.0
                  # mask_dice: 1.0
                costs:
                  mask_bce: 1.0
                  # mask_dice: 1.0
                dim: *dim
                null_weight: 1.0

            - class_path: hepattn.models.task.ObjectRegressionTask
              init_args:
                name: parameter_regression
                input_object: query
                output_object: track
                target_object: particle
                dim: *dim
                loss_weight: 1.0
                fields:
                  - truthMuon_eta
                  - truthMuon_phi
                  - truthMuon_qpt